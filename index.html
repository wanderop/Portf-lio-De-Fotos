<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Portf√≥lio ‚Äî Google Fotos (Configurado)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body,html{height:100%} 
    #bgVideo{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:-1}
    .card{background:rgba(17,24,39,.85);backdrop-filter:blur(6px) saturate(120%);border-radius:.75rem;padding:1rem}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.6rem}
    .btn{padding:.5rem .8rem;border-radius:.6rem}
    .btn-primary{background:#7c3aed;color:#fff}
    .btn-gray{background:#374151;color:#fff}
  </style>
</head>
<body class="bg-gray-900 text-gray-100">

  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="top-bg.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <header class="bg-transparent text-white px-4 py-3 shadow-lg flex items-center justify-between relative z-10">
    <h1 class="text-xl font-bold">üìÅ Portf√≥lio ‚Äî Google Fotos</h1>
    <div class="flex gap-2">
      <button id="gpSignIn" class="btn btn-primary">Entrar com Google</button>
      <button id="gpSignOut" class="btn btn-gray hidden">Sair</button>
    </div>
  </header>

  <main class="relative z-10 p-4 space-y-4">
    <div class="card">
      <h2 class="text-lg font-semibold">Conectar ao Google Fotos</h2>
      <p class="text-sm text-gray-300">
        Clique em <b>Entrar com Google</b> para listar seus √°lbuns.<br>
        Escopo usado: <code>https://www.googleapis.com/auth/photoslibrary.readonly</code>
      </p>
      <p id="gpStatus" class="text-xs text-gray-400 mt-1"></p>
    </div>

    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Meus √Ålbuns</h3>
        <button id="gpRefreshAlbums" class="btn btn-gray">üîÑ Atualizar</button>
      </div>
      <div id="albumsGrid" class="grid-auto"></div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h3 id="albumTitle" class="font-semibold">Itens do √Ålbum</h3>
        <div class="flex gap-2 items-center">
          <input type="text" id="maxDim" value="1600" class="px-2 py-1 rounded bg-gray-800 text-sm w-20" title="Dimens√£o m√°x. do preview">
          <button id="gpLoadMore" class="btn btn-gray">Carregar mais</button>
        </div>
      </div>
      <div id="mediaGrid" class="grid-auto"></div>
    </div>
  </main>

<script>
const OAUTH_CLIENT_ID = "439447494801-dhcai5nkhv1rh86nna96vf2g2i5f6d9d.apps.googleusercontent.com";
const OAUTH_REDIRECT_URI = "https://wanderop.github.io/Portf-lio-De-Fotos/";
const SCOPE = "https://www.googleapis.com/auth/photoslibrary.readonly";
const TOKEN_KEY = "gp_token_only";
let token = null;
let nextPageToken = null;
let currentAlbum = null;

function setStatus(msg){ document.getElementById('gpStatus').textContent = msg || ""; }
function saveToken(t){ localStorage.setItem(TOKEN_KEY, JSON.stringify(t)); }
function loadToken(){ try { return JSON.parse(localStorage.getItem(TOKEN_KEY)||"null"); } catch(e){ return null; } }
function clearToken(){ localStorage.removeItem(TOKEN_KEY); }

async function sha256(str){ const enc = new TextEncoder().encode(str); const buf = await crypto.subtle.digest('SHA-256', enc); return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function randomString(len=64){ const chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~'; let s=''; for(let i=0;i<len;i++){ s+=chars[Math.floor(Math.random()*chars.length)]; } return s; }

async function signIn(){
  const verifier = randomString(64);
  const challenge = await sha256(verifier);
  sessionStorage.setItem('pkce_verifier', verifier);
  const url = new URL('https://accounts.google.com/o/oauth2/v2/auth');
  url.searchParams.set('client_id', OAUTH_CLIENT_ID);
  url.searchParams.set('redirect_uri', OAUTH_REDIRECT_URI);
  url.searchParams.set('response_type', 'code');
  url.searchParams.set('scope', SCOPE);
  url.searchParams.set('include_granted_scopes', 'true');
  url.searchParams.set('access_type', 'online');
  url.searchParams.set('code_challenge', challenge);
  url.searchParams.set('code_challenge_method', 'S256');
  window.location.href = url.toString();
}

async function handleRedirect(){
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const error = params.get('error');
  if(error){ setStatus("Erro no login: "+error); return; }
  if(!code) return;
  const verifier = sessionStorage.getItem('pkce_verifier');
  if(!verifier){ setStatus("PKCE verifier ausente."); return; }
  const data = new URLSearchParams();
  data.set('client_id', OAUTH_CLIENT_ID);
  data.set('code', code);
  data.set('grant_type', 'authorization_code');
  data.set('redirect_uri', OAUTH_REDIRECT_URI);
  data.set('code_verifier', verifier);
  const resp = await fetch('https://oauth2.googleapis.com/token', {
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: data
  });
  const json = await resp.json();
  if(json.error){ setStatus("Falha no token: "+(json.error_description||json.error)); return; }
  token = json; saveToken(token);
  window.history.replaceState({}, '', OAUTH_REDIRECT_URI);
  updateAuthUI();
  await listAlbums();
}

function signOut(){ token=null; clearToken(); updateAuthUI(); }
function updateAuthUI(){
  const btnIn = document.getElementById('gpSignIn');
  const btnOut = document.getElementById('gpSignOut');
  if(token){
    btnIn.classList.add('hidden'); btnOut.classList.remove('hidden'); setStatus("Logado. Token expira em ~"+(token.expires_in||3600)+"s.");
  } else {
    btnIn.classList.remove('hidden'); btnOut.classList.add('hidden'); setStatus("");
    document.getElementById('albumsGrid').innerHTML = "";
    document.getElementById('mediaGrid').innerHTML = "";
  }
}

async function gpFetch(path, method='GET', body=null){
  if(!token) throw new Error("Sem token");
  const resp = await fetch('https://photoslibrary.googleapis.com/v1'+path, {
    method, headers:{ 'Authorization':'Bearer '+token.access_token, 'Content-Type':'application/json' },
    body: body? JSON.stringify(body): null
  });
  if(resp.status===401){ setStatus("Token expirado. Fa√ßa login novamente."); signOut(); return null; }
  return resp.json();
}

async function listAlbums(){
  if(!token){ setStatus("Fa√ßa login."); return; }
  const albumsGrid = document.getElementById('albumsGrid');
  albumsGrid.innerHTML = "Carregando...";
  const data = await gpFetch('/albums?pageSize=50');
  albumsGrid.innerHTML = "";
  (data.albums||[]).forEach(a=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<div class="text-sm font-semibold mb-1">${a.title||'(Sem t√≠tulo)'}</div>
      <div class="text-xs text-gray-400 mb-2">${a.mediaItemsCount||0} itens</div>
      <button class="btn btn-primary">Abrir</button>`;
    card.querySelector('button').onclick = ()=>{ openAlbum(a); };
    albumsGrid.appendChild(card);
  });
}

async function openAlbum(album){
  currentAlbum = album;
  nextPageToken = null;
  document.getElementById('albumTitle').textContent = `Itens do √Ålbum ‚Äî ${album.title||'(Sem t√≠tulo)'}`;
  const mediaGrid = document.getElementById('mediaGrid'); mediaGrid.innerHTML='';
  await loadMoreItems();
}

async function loadMoreItems(){
  if(!currentAlbum) return;
  const mediaGrid = document.getElementById('mediaGrid');
  const pageSize = 50;
  const resp = await gpFetch('/mediaItems:search','POST',{
    albumId: currentAlbum.id,
    pageSize, pageToken: nextPageToken || undefined
  });
  nextPageToken = resp.nextPageToken || null;
  const maxDim = parseInt(document.getElementById('maxDim').value||'1600',10);
  (resp.mediaItems||[]).forEach(m=>{
    let thumb = m.baseUrl + `=w${maxDim}-h${maxDim}`;
    const card = document.createElement('div'); card.className='relative group';
    if((m.mimeType||'').startsWith('video/')){
      const a = document.createElement('a'); a.href = m.productUrl; a.target='_blank'; a.rel='noopener';
      a.innerHTML = `<video src="${m.baseUrl}=dv" class="w-full rounded-lg shadow" muted playsinline></video>`;
      card.appendChild(a);
    } else {
      const img = document.createElement('img'); img.src = thumb; img.className='w-full rounded-lg shadow'; img.alt = m.filename || 'Foto';
      card.appendChild(img);
    }
    mediaGrid.appendChild(card);
  });
}

document.getElementById('gpSignIn').onclick = signIn;
document.getElementById('gpSignOut').onclick = signOut;
document.getElementById('gpRefreshAlbums').onclick = listAlbums;
document.getElementById('gpLoadMore').onclick = loadMoreItems;

(async function init(){
  token = loadToken();
  updateAuthUI();
  await handleRedirect();
  if(token){ listAlbums(); }
})();
</script>

</body>
</html>