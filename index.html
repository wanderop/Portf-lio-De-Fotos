<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Portf√≥lio ‚Äî Google Fotos (GIS)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body,html{height:100%} 
    #bgVideo{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:-1}
    .pill{padding:.25rem .6rem;border-radius:9999px;background:#4b5563;font-size:.85rem}
    .pill.active{background:#7c3aed;color:#fff}
    .card{background:rgba(17,24,39,.85);backdrop-filter:blur(6px) saturate(120%);border-radius:.75rem;padding:1rem}
    .grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.6rem}
    .btn{padding:.5rem .8rem;border-radius:.6rem}
    .btn-primary{background:#7c3aed;color:#fff}
    .btn-gray{background:#374151;color:#fff}
    .alert{background:#1f2937;border-left:4px solid #ef4444;padding:.5rem .75rem;border-radius:.375rem}
  </style>
</head>
<body class="bg-gray-900 text-gray-100">

  <video id="bgVideo" autoplay muted loop playsinline>
    <source src="top-bg.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <header class="bg-transparent text-white px-4 py-3 shadow-lg flex items-center justify-between relative z-10">
    <h1 class="text-xl font-bold">üìÅ Portf√≥lio ‚Äî Google Fotos</h1>
    <div class="flex gap-2">
      <button id="btnLogin" class="btn btn-primary">Entrar com Google</button>
      <button id="btnLogout" class="btn btn-gray hidden">Sair</button>
    </div>
  </header>

  <main class="relative z-10 p-4 space-y-4">
    <div class="card">
      <h2 class="text-lg font-semibold">Conectar ao Google Fotos</h2>
      <p class="text-sm text-gray-300">
        Usa <b>Google Identity Services (Token Client)</b>. Autorize <code>https://wanderop.github.io</code> como <i>Authorized JavaScript origin</i> no Console.
      </p>
      <ul class="text-xs text-gray-300 list-disc pl-5">
        <li>Escopo: <code>https://www.googleapis.com/auth/photoslibrary.readonly</code></li>
      </ul>
      <div id="status" class="text-xs text-gray-300 mt-2"></div>
      <div id="errorBox" class="alert mt-2 hidden"></div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Meus √Ålbuns</h3>
        <div class="flex gap-2">
          <button id="btnAllPhotos" class="btn btn-gray">üìö Todas as fotos</button>
          <button id="btnRefresh" class="btn btn-gray">üîÑ Atualizar</button>
        </div>
      </div>
      <div id="albumsGrid" class="grid-auto"></div>
    </div>

    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h3 id="albumTitle" class="font-semibold">Itens do √Ålbum</h3>
        <div class="flex gap-2 items-center">
          <input type="text" id="maxDim" value="1600" class="px-2 py-1 rounded bg-gray-800 text-sm w-20" title="Dimens√£o m√°x. do preview">
          <button id="btnMore" class="btn btn-gray">Carregar mais</button>
        </div>
      </div>
      <div id="mediaGrid" class="grid-auto"></div>
    </div>
  </main>

  <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
    <div class="absolute top-3 right-3 flex gap-2">
      <button id="lbDownload" class="px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-xs font-semibold">‚¨á Baixar</button>
      <button id="lbClose" class="px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs font-semibold">‚úñ Fechar</button>
    </div>
    <div id="lbContent" class="max-w-[90%] max-h-[80%]"></div>
  </div>

<script>
const CLIENT_ID = "439447494801-dhcai5nkhv1rh86nna96vf2g2i5f6d9d.apps.googleusercontent.com";
const SCOPE = "https://www.googleapis.com/auth/photoslibrary.readonly";

let accessToken = null;
let tokenClient = null;
let nextPageToken = null;
let currentAlbum = null;
let listingAll = false;

function setStatus(msg){ document.getElementById('status').textContent = msg || ""; }
function showError(msg){ const box=document.getElementById('errorBox'); box.textContent=msg; box.classList.remove('hidden'); }
function clearError(){ document.getElementById('errorBox').classList.add('hidden'); document.getElementById('errorBox').textContent=""; }

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPE,
    prompt: 'consent',
    callback: (resp) => {
      if (resp && resp.access_token) {
        accessToken = resp.access_token;
        localStorage.setItem('gp_gis_token', accessToken);
        document.getElementById('btnLogin').classList.add('hidden');
        document.getElementById('btnLogout').classList.remove('hidden');
        setStatus('Logado.');
        clearError();
        listAlbums();
      } else {
        showError('Falha ao obter token.');
      }
    }
  });

  const cached = localStorage.getItem('gp_gis_token');
  if(cached){
    accessToken = cached;
    document.getElementById('btnLogin').classList.add('hidden');
    document.getElementById('btnLogout').classList.remove('hidden');
    listAlbums();
  }
};

document.getElementById('btnLogin').onclick = () => tokenClient.requestAccessToken({include_granted_scopes:true});
document.getElementById('btnLogout').onclick = () => {
  accessToken = null; localStorage.removeItem('gp_gis_token');
  document.getElementById('btnLogin').classList.remove('hidden');
  document.getElementById('btnLogout').classList.add('hidden');
  document.getElementById('albumsGrid').innerHTML = '';
  document.getElementById('mediaGrid').innerHTML = '';
  setStatus('Desconectado.');
};
document.getElementById('btnRefresh').onclick = () => listAlbums();
document.getElementById('btnMore').onclick = () => loadMoreItems();
document.getElementById('btnAllPhotos').onclick = () => { currentAlbum=null; listingAll=true; nextPageToken=null; document.getElementById('albumTitle').textContent='Todas as fotos'; document.getElementById('mediaGrid').innerHTML=''; loadMoreItems(); };

async function gpFetch(path, method='GET', body=null){
  if(!accessToken){ setStatus('Fa√ßa login.'); return null; }
  const resp = await fetch('https://photoslibrary.googleapis.com/v1'+path, {
    method, headers: { 'Authorization': 'Bearer '+accessToken, 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : null
  });
  if(!resp.ok){
    const text = await resp.text();
    let msg = 'Falha na API ('+resp.status+'): '+text;
    try { const j=JSON.parse(text); if(j.error && j.error.message) msg = j.error.message + ' ['+resp.status+']'; } catch(e){}
    showError(msg + (resp.status===403? ' ‚Äî Dica: garanta que o escopo photoslibrary.readonly est√° adicionado na Tela de consentimento e refa√ßa o login (remova o app em https://myaccount.google.com/permissions).':''));
    return null;
  }
  clearError();
  return resp.json();
}

async function listAlbums(){
  listingAll=false;
  const grid = document.getElementById('albumsGrid');
  grid.innerHTML = 'Carregando...';
  const data = await gpFetch('/albums?pageSize=50');
  grid.innerHTML = '';
  if(!data) return;
  (data.albums||[]).forEach(a => {
    const card = document.createElement('div'); card.className = 'card';
    card.innerHTML = `<div class="text-sm font-semibold mb-1">${a.title||'(Sem t√≠tulo)'}</div>
      <div class="text-xs text-gray-400 mb-2">${a.mediaItemsCount||0} itens</div>
      <button class="btn btn-primary">Abrir</button>`;
    card.querySelector('button').onclick = () => openAlbum(a);
    grid.appendChild(card);
  });
  if(!data.albums || !data.albums.length){
    setStatus('Sem √°lbuns encontrados. Use ‚ÄúTodas as fotos‚Äù.');
  } else { setStatus(''); }
}

async function openAlbum(album){
  currentAlbum = album; listingAll=false; nextPageToken = null;
  document.getElementById('albumTitle').textContent = 'Itens do √Ålbum ‚Äî ' + (album.title || '(Sem t√≠tulo)');
  document.getElementById('mediaGrid').innerHTML = '';
  await loadMoreItems();
}

async function loadMoreItems(){
  const mediaGrid = document.getElementById('mediaGrid');
  const maxDim = parseInt(document.getElementById('maxDim').value || '1600', 10);
  let data=null;
  if(listingAll){
    data = await gpFetch('/mediaItems?pageSize=50'+(nextPageToken? '&pageToken='+encodeURIComponent(nextPageToken):''));
  } else if(currentAlbum){
    data = await gpFetch('/mediaItems:search','POST', { albumId: currentAlbum.id, pageSize: 50, pageToken: nextPageToken || undefined });
  } else {
    return;
  }
  if(!data) return;
  nextPageToken = data.nextPageToken || null;
  (data.mediaItems||[]).forEach(m => {
    const card = document.createElement('div'); card.className = 'relative group';
    if((m.mimeType||'').startsWith('video/')){
      const a = document.createElement('a'); a.href = m.productUrl; a.target = '_blank'; a.rel='noopener';
      a.innerHTML = `<video src="${m.baseUrl}=dv" class="w-full rounded-lg shadow" muted playsinline></video>`;
      card.appendChild(a);
    }else{
      const img = document.createElement('img'); img.src = m.baseUrl + `=w${maxDim}-h${maxDim}`; img.className='w-full rounded-lg shadow cursor-zoom-in';
      img.dataset.baseurl = m.baseUrl; img.dataset.filename = m.filename || 'foto.jpg';
      img.onclick = ()=>openLightbox(img.src, img.dataset.baseurl, img.dataset.filename);
      card.appendChild(img);
    }
    mediaGrid.appendChild(card);
  });
}

// Lightbox + download
const lb=document.getElementById('lightbox'); const lbContent=document.getElementById('lbContent'); 
const lbClose=document.getElementById('lbClose'); const lbDownload=document.getElementById('lbDownload');
let zoom=1, startX=0, startY=0, tx=0, ty=0, panning=false;
let currentBase='', currentName='foto.jpg', currentImg=null;

lbClose.onclick=()=>{ lb.classList.add('hidden'); lbContent.innerHTML=''; };

async function downloadCurrent(){
  if(!currentBase) return;
  const url = currentBase + '=d';
  try{
    // tente sem auth
    let resp = await fetch(url);
    if(resp.status===401 || resp.status===403){
      // tenta com auth
      resp = await fetch(url, { headers: { 'Authorization': 'Bearer '+accessToken }});
    }
    const blob = await resp.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = currentName || 'foto.jpg';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }catch(e){
    alert('Falha ao baixar: '+e.message);
  }
}
lbDownload.onclick=downloadCurrent;

function openLightbox(src, baseUrl, filename){
  lb.classList.remove('hidden'); lb.classList.add('flex'); lbContent.innerHTML='';
  const img=document.createElement('img'); img.src=src; img.className='max-h-[80vh] mx-auto rounded-xl border-4 border-white select-none';
  lbContent.appendChild(img);
  currentBase = baseUrl || ''; currentName = filename || 'foto.jpg'; currentImg=img;
  zoom=1; tx=0; ty=0; panning=false; img.style.transformOrigin='center center';
  const apply=()=>{ img.style.transform=`translate(${tx}px, ${ty}px) scale(${zoom})`; img.style.cursor=zoom>1?(panning?'grabbing':'grab'):'zoom-in'; };
  img.addEventListener('wheel',(e)=>{ e.preventDefault(); const d=e.deltaY>0?-0.2:0.2; zoom=Math.max(1,Math.min(4,zoom+d)); apply(); },{passive:false});
  img.addEventListener('dblclick',()=>{ zoom=zoom===1?2.5:1; tx=0; ty=0; apply(); });
  img.addEventListener('mousedown',(e)=>{ if(zoom===1) return; panning=true; startX=e.clientX-tx; startY=e.clientY-ty; apply(); });
  window.addEventListener('mousemove',(e)=>{ if(!panning) return; tx=e.clientX-startX; ty=e.clientY-startY; apply(); });
  window.addEventListener('mouseup',()=>{ panning=false; apply(); });
  apply();
}
</script>

</body>
</html>
